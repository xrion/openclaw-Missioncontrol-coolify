services:
  registry:
    image: registry:2
    restart: unless-stopped
    volumes:
      - registry-data:/var/lib/registry
    environment:
      REGISTRY_HTTP_SECRET: ${SERVICE_BASE64_REGISTRY}
  openclaw:
    build:
      context: .
      args:
        - OPENCLAW_BETA=${OPENCLAW_BETA:-false}
    restart: on-failure:10
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    env_file:
      - .env
    environment:
      DOCKER_HOST: tcp://docker-proxy:2375
      OPENCLAW_ENABLE_WEBHOOK_PROXY: "1"
      PORT: 18789
      NODE_ENV: production
      NODE_OPTIONS: '--max-old-space-size=4096'
      HOME: /data
      TERM: xterm-256color
      # Persistence: Command History
      HISTFILE: /data/.bash_history
      HISTSIZE: 50000
      HISTSAVE: 50000
      HISTCONTROL: ignoreboth
      XDG_CONFIG_HOME: /data/.config
      XDG_DATA_HOME: /data/.local/share
      XDG_CACHE_HOME: /data/.cache
      NPM_CONFIG_CACHE: /data/.npm
      BUN_INSTALL: /data/.bun
      # Map OpenClaw vars
      OPENCLAW_GATEWAY_BIND: lan
      OPENCLAW_GATEWAY_PORT: ${OPENCLAW_GATEWAY_PORT:-18789}
      # Tell the binary where to look for state/config
      OPENCLAW_STATE_DIR: /data/.openclaw
      OPENCLAW_WORKSPACE: /data/openclaw-workspace

      # API Keys injected from .env or Coolify
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      MINIMAX_API_KEY: ${MINIMAX_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      KIMI_API_KEY: ${KIMI_API_KEY}
      OPENCODE_API_KEY: ${OPENCODE_API_KEY}
      MOONSHOT_API_KEY: ${KIMI_API_KEY}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      SANDBOX_CONTAINER: ${SANDBOX_CONTAINER:-false}
      
      # Optional integrations
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
      NANOBANANA_API_KEY: ${NANOBANANA_API_KEY}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY}

      SERVICE_URL_OPENCLAW_18789: null
      SERVICE_URL_OPENCLAWWEBHOOK_8788: null
      BASE_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      PUBLIC_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      # Bootstrap controls
      OPENCLAW_AUTO_BOOTSTRAP: "1"
      OPENCLAW_PRINT_ACCESS: "1"
      GATEWAY_TRUSTED_PROXIES: '*'
      # Fix for EMFILE/Inotify issues in Docker
      CHOKIDAR_USEPOLLING: "true"
      # Public URL Access

      CF_TUNNEL_TOKEN: ${CF_TUNNEL_TOKEN}
      # Deployment & Git
      VERCEL_ORG_ID: ${VERCEL_ORG_ID}
      VERCEL_PROJECT_ID: ${VERCEL_PROJECT_ID}
      VERCEL_TOKEN: ${VERCEL_TOKEN}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_USERNAME: ${GITHUB_USERNAME}
      GITHUB_EMAIL: ${GITHUB_EMAIL}
      # Optional
      OPENCLAW_BETA: ${OPENCLAW_BETA:-false}

      # Mission Control (Convex)
      CONVEX_URL: ${CONVEX_URL:-}
      CONVEX_DEPLOY_KEY: ${CONVEX_DEPLOY_KEY:-}
      # Force-enable Mission Control when Convex is configured
      MISSION_CONTROL_ENABLED: ${MISSION_CONTROL_ENABLED:-true}

    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
    volumes:
      - openclaw-data:/data
      - openclaw-config:/root/.openclaw
      - openclaw-workspace:/root/openclaw-workspace
      - mc-shared:/mc-shared

      # Secure: Socket mount removed in favor of proxy
      # - /var/run/docker.sock:/var/run/docker.sock

    depends_on:
      - docker-proxy

    command: ["bash", "/app/scripts/bootstrap.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Security: Only enable necessary Docker APIs
      POST: 1       # Create containers
      CONTAINERS: 1 # List/manage containers
      IMAGES: 1     # Pull images
      NETWORKS: 1   # Connect to networks
      INFO: 1       # Version check
      VERSION: 1
      EXEC: 1       # Run commands (exec)
      EVENTS: 1     # Listen for events (if needed)

  searxng:
    build:
      context: .
      dockerfile: searxng/Dockerfile
    restart: unless-stopped
    volumes:
      - searxng-data:/var/lib/searxng
    environment:
      SEARXNG_BASE_URL: http://searxng:8080
      SEARXNG_SERVER_SECRET_KEY: ${SERVICE_BASE64_SEARXNG}
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

  mission-control:
    build:
      context: ./mission-control
      args:
        - VITE_CONVEX_URL=${CONVEX_URL:-}
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Expose Convex URL at runtime for diagnostics/health (build-time already set via ARG)
      VITE_CONVEX_URL: ${CONVEX_URL:-}
      PORT: 3000
    expose:
      - "3000"
    ports:
      - "${MC_PORT:-3000}:3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mission-control.rule=Host(`${SERVICE_FQDN_MISSION_CONTROL}`)"
      - "traefik.http.routers.mission-control.entrypoints=websecure"
      - "traefik.http.routers.mission-control.tls=true"
      - "traefik.http.routers.mission-control.service=mission-control"
      - "traefik.http.services.mission-control.loadbalancer.server.port=3000"
      - "traefik.docker.network=coolify"
    volumes:
      - mc-shared:/mc-shared:ro
    depends_on:
      openclaw:
        condition: service_healthy
      convex-sync:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  convex-sync:
    image: node:20-slim
    working_dir: /app/mission-control
    env_file:
      - .env
    environment:
      CONVEX_URL: ${CONVEX_URL:-}
      CONVEX_DEPLOY_KEY: ${CONVEX_DEPLOY_KEY:-}
    volumes:
      - ./:/app:ro
      - openclaw-data:/data
    command: >
      bash -lc "set -e
        if [ -z \"$CONVEX_URL\" ]; then
          echo 'convex-sync: CONVEX_URL not set, skipping.'
          exit 0
        fi
        cd /app/mission-control
        # Ensure convex CLI is available (downloaded on demand)
        npx --yes convex@1.17.0 --version >/dev/null
        # Deploy schema if deploy key provided (idempotent)
        if [ -n \"$CONVEX_DEPLOY_KEY\" ]; then
          CONVEX_DEPLOY_KEY=\"$CONVEX_DEPLOY_KEY\" npx convex deploy --url \"$CONVEX_URL\" || true
        fi
        # Register agents from openclaw.json (upsert)
        if [ ! -f /data/.openclaw/openclaw.json ]; then
          echo 'convex-sync: config not found at /data/.openclaw/openclaw.json'
          exit 0
        fi
        node -e \"const fs=require('fs'),{spawnSync}=require('child_process');const cfg=JSON.parse(fs.readFileSync('/data/.openclaw/openclaw.json','utf8'));const url=process.env.CONVEX_URL;for(const a of (cfg.agents&&cfg.agents.list)||[]){const args={agentId:a.id,name:a.name||a.id,role:a.role||'agent',description:a.description||'Imported from openclaw.json',heartbeatInterval:900000,avatar:a.avatar};console.log('convex-sync: registering',args.agentId);const r=spawnSync('npx',['convex','run','agents:register','--url',url,'--args',JSON.stringify(args)],{stdio:'inherit'});if(r.status!==0)console.error('convex-sync: register failed for',args.agentId);}}\""
    restart: "no"
    depends_on:
      openclaw:
        condition: service_healthy

volumes:
  openclaw-data:
  openclaw-config:
  openclaw-workspace:
  mc-shared:
  searxng-data:
  registry-data:
